--- linux-2.4.20/drivers/addon/cipe/output.c.ORIG	2003-04-02 00:51:46.000000000 -0800
+++ linux-2.4.20/drivers/addon/cipe/output.c	2003-04-02 01:04:25.000000000 -0800
@@ -109,13 +109,6 @@
 }
 #endif
 
-/* Need this wrapper because NF_HOOK takes the function address, and
-   ip_send was declared "extern inline" in the vague past. --RR */
-static inline int do_ip_send(struct sk_buff *skb)
-{
-	return ip_send(skb);
-}
-
 int cipe_xmit(struct sk_buff *skb, struct NET_DEVICE *dev)
 {
         struct cipe *tunnel = (struct cipe*)(dev->priv);
@@ -171,13 +164,22 @@
                           cipe_ntoa(0, dst), cipe_ntoa(1, tunnel->myaddr),
                           RT_TOS(tos), tunnel->sock->bound_dev_if));
 #endif
-	if (ip_route_output(&rt, dst, tunnel->sock->rcv_saddr, RT_TOS(tos),
-                            tunnel->sock->bound_dev_if)) {
-            dprintk(DEB_OUT, (KERN_NOTICE "%s: no route\n", dev->name));
-            tunnel->stat.tx_carrier_errors++;
-            dst_link_failure(skb);
-            goto tx_error_out;
-        }
+	{
+		struct flowi fl = {
+			.oif = tunnel->sock->bound_dev_if,
+			.nl_u = { .ip4_u =
+				  { .daddr = dst,
+				    .saddr = tunnel->sock->rcv_saddr,
+				    .tos = RT_TOS(tos) } } };
+
+		if (ip_route_output_key(&rt, &fl)) {
+			dprintk(DEB_OUT, (KERN_NOTICE "%s: no route\n",
+					  dev->name));
+			tunnel->stat.tx_carrier_errors++;
+			dst_link_failure(skb);
+			goto tx_error_out;
+		}
+	}
         if (rt->rt_src!=tunnel->myaddr) {
             printk(KERN_NOTICE "%s: changing my address: %s\n", dev->name,
                    cipe_ntoa(rt->rt_src));
@@ -194,7 +196,7 @@
 		goto tx_error;
 	}
 
-        mtu = rt->u.dst.pmtu - (cipehdrlen+cipefootlen);
+        mtu = dst_pmtu(&rt->u.dst) - (cipehdrlen+cipefootlen);
         if (tunnel->sockshost)
             mtu -= sizeof(struct sockshdr);
 
@@ -206,8 +208,8 @@
 		tunnel->stat.collisions++;
 		goto tx_error;
 	}
-	if (skb->dst && mtu < skb->dst->pmtu) {
-		skb->dst->pmtu = mtu;
+	if (skb->dst && mtu < dst_pmtu(skb->dst)) {
+		skb->dst->ops->update_pmtu(skb->dst, mtu);
         	dprintk(DEB_OUT, (KERN_NOTICE "%s: adjusting PMTU\n", dev->name));
 #if 0
                 /* TEST: is this OK? */
@@ -329,7 +331,7 @@
 #if 0
         dprintk(DEB_OUT, (KERN_DEBUG "dst: (%d,%d) %s %d %d\n",
                           skb->dst->refcnt, skb->dst->use,
-                          skb->dst->dev->name, skb->dst->pmtu,
+                          skb->dst->dev->name, dst_pmtu(skb->dst),
                           skb->dst->error));
 #endif
 #ifdef DEBUG
@@ -339,7 +341,7 @@
 
 	/* Send "new" packet from local host */
 	NF_HOOK(PF_INET, NF_IP_LOCAL_OUT, skb, NULL, rt->u.dst.dev,
-		do_ip_send);
+		dst_output);
         tunnel->recursion--;
 	return 0;
 
