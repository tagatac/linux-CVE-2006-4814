diff -urNp linux-640/drivers/block/loop.c linux-650/drivers/block/loop.c
--- linux-640/drivers/block/loop.c	
+++ linux-650/drivers/block/loop.c	
@@ -740,9 +740,14 @@ static int loop_change_fd(struct loop_de
                struct file *old_backing_file;
  
                error = -EINVAL;
-               if (size != loop_sizes[lo->lo_number])
-                       /* Loop size has changed. Don't allow it. */
-                       goto out_put_all;
+               if (size != loop_sizes[lo->lo_number]) {
+                       /* Loop size has changed. Don't allow it and return -EINVAL.
+                        * We need to double fput here; one for the fget() and
+                        * one for the get_file();
+                        */
+                       fput(file);                       	
+                       goto out_putf;
+               }
  
                init_MUTEX(&sem);
  
@@ -763,7 +768,7 @@ static int loop_change_fd(struct loop_de
                   old backing file/device */
                down(&sem);
                lo->lo_change = NULL;
-               fput(old_backing_file);
+               filp_close(old_backing_file, NULL);
                error = 0;
        }
   
@@ -846,7 +851,7 @@ static int loop_clr_fd(struct loop_devic
 	invalidate_bdev(bdev, 0);
 	filp->f_dentry->d_inode->i_mapping->gfp_mask = gfp;
 	lo->lo_state = Lo_unbound;
-	fput(filp);
+	filp_close(filp, NULL);
 	MOD_DEC_USE_COUNT;
 	return 0;
 }
@@ -970,6 +975,7 @@ static int lo_ioctl(struct inode * inode
 		break;
 	case BLKBSZGET:
 	case BLKBSZSET:
+	case BLKSSZGET:
 		err = blk_ioctl(inode->i_rdev, cmd, arg);
 		break;
 	default:
