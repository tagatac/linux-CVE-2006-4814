diff -urNp linux-8143/drivers/scsi/Makefile linux-8144/drivers/scsi/Makefile
--- linux-8143/drivers/scsi/Makefile
+++ linux-8144/drivers/scsi/Makefile
@@ -176,7 +176,7 @@ a100u2w-objs	:= inia100.o i60uscsi.o
 zalon7xx_mod-objs := zalon7xx.o ncr53c8xx.o
 cpqfc-objs	:= cpqfcTSinit.o cpqfcTScontrol.o cpqfcTSi2c.o \
 		   cpqfcTSworker.o cpqfcTStrigger.o
-libata-objs	:= libata-core.o libata-scsi.o
+libata-objs	:= libata-core.o libata-scsi.o libata-dump.o
 
 include $(TOPDIR)/Rules.make
 
diff -urNp linux-8143/drivers/scsi/ata_piix.c linux-8144/drivers/scsi/ata_piix.c
--- linux-8143/drivers/scsi/ata_piix.c
+++ linux-8144/drivers/scsi/ata_piix.c
@@ -47,6 +47,7 @@
 #include <linux/delay.h>
 #include "scsi.h"
 #include <scsi/scsi_host.h>
+#include "scsi_dump.h"
 #include <linux/libata.h>
 
 #define DRV_NAME	"ata_piix"
@@ -697,6 +698,7 @@ static int __init piix_init(void)
 		rc = -ENODEV;
 		goto err_out;
 	}
+	scsi_dump_register(&piix_sht, &ata_scsi_dump_ops);
 
 	DPRINTK("done\n");
 	return 0;
@@ -708,6 +710,7 @@ err_out:
 
 static void __exit piix_exit(void)
 {
+	scsi_dump_unregister(&piix_sht);
 	scsi_unregister_module(MODULE_SCSI_HA, &piix_sht);
 	pci_unregister_driver(&piix_pci_driver);
 }
diff -urNp linux-8143/drivers/scsi/libata-core.c linux-8144/drivers/scsi/libata-core.c
--- linux-8143/drivers/scsi/libata-core.c
+++ linux-8144/drivers/scsi/libata-core.c
@@ -3231,7 +3231,7 @@ static void ata_pio_error(struct ata_por
 	ata_poll_qc_complete(qc, AC_ERR_ATA_BUS);
 }
 
-static void ata_pio_task(void *_data)
+void ata_pio_task(void *_data)
 {
 	struct ata_port *ap = _data;
 	unsigned long timeout;
@@ -4982,6 +4982,10 @@ EXPORT_SYMBOL_GPL(ata_scsi_detect);
 EXPORT_SYMBOL_GPL(ata_add_to_probe_list);
 EXPORT_SYMBOL_GPL(ssleep);
 EXPORT_SYMBOL_GPL(ata_scsi_release);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_sanity_check);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_quiesce);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_poll);
+EXPORT_SYMBOL_GPL(ata_scsi_dump_ops);
 EXPORT_SYMBOL_GPL(ata_host_intr);
 EXPORT_SYMBOL_GPL(ata_dev_classify);
 EXPORT_SYMBOL_GPL(ata_dev_id_string);
diff -urNp linux-8143/drivers/scsi/libata-dump.c linux-8144/drivers/scsi/libata-dump.c
--- linux-8143/drivers/scsi/libata-dump.c
+++ linux-8144/drivers/scsi/libata-dump.c
@@ -0,0 +1,99 @@
+/*
+   libata-dump.c - helper library for SATA diskdump
+*/
+
+#include <linux/kernel.h>
+#include <linux/blkdev.h>
+#include <linux/spinlock.h>
+#include <scsi/scsi.h>
+#include "scsi.h"
+#include <scsi/scsi_host.h>
+#include <linux/libata.h>
+
+#include "libata.h"
+#include "scsi_dump.h"
+
+int ata_scsi_dump_sanity_check(struct scsi_device *sdev)
+{
+	struct ata_port *ap;
+	struct ata_device *dev;
+
+	ap = (struct ata_port *) &sdev->host->hostdata[0];
+	dev = ata_scsi_find_dev(ap, sdev);
+
+	if (!ata_dev_present(dev))
+		return -EIO;
+	if (ap->flags & ATA_FLAG_PORT_DISABLED)
+		return -EIO;
+
+	return 0;
+}
+
+static int ata_scsi_dump_run_bottomhalf(struct ata_port *ap)
+{
+	static struct pt_regs regs;	/* dummy */
+	struct ata_host_set *host_set;
+	struct ata_queued_cmd *qc;
+	int handled = 0;
+
+	host_set = ap->host_set;
+
+	if (!list_empty(&ap->pio_task.list)) {
+		list_del_init(&ap->pio_task.list);
+		ap->pio_task.sync = 0;
+
+		ata_pio_task(ap);
+		handled = 1;
+	}
+
+	qc = ata_qc_from_tag(ap, ap->active_tag);
+	if (qc) {
+		ap->ops->irq_handler(host_set->irq, host_set, &regs);
+		handled = 1;
+	}
+
+	return handled;
+}
+
+int ata_scsi_dump_quiesce(struct scsi_device *sdev)
+{
+	struct ata_port *ap;
+	struct ata_device *dev;
+	int handled;
+
+	ap = (struct ata_port *) &sdev->host->hostdata[0];
+	dev = ata_scsi_find_dev(ap, sdev);
+
+	do {
+		handled = ata_scsi_dump_run_bottomhalf(ap);
+	} while (handled);
+
+	if (ap->flags & ATA_FLAG_PORT_DISABLED)
+		return -EIO;
+
+	return 0;
+}
+
+void ata_scsi_dump_poll(struct scsi_device *sdev)
+{
+	struct ata_port *ap;
+	struct ata_device *dev;
+
+	ap = (struct ata_port *) &sdev->host->hostdata[0];
+	dev = ata_scsi_find_dev(ap, sdev);
+
+	if (ap->flags & ATA_FLAG_PORT_DISABLED) {
+		printk(KERN_ERR "ata%u(%u): port disabled\n",
+		       ap->id, dev->devno);
+		return;
+	}
+
+	ata_scsi_dump_run_bottomhalf(ap);
+}
+
+struct scsi_dump_ops ata_scsi_dump_ops = {
+	.sanity_check		= ata_scsi_dump_sanity_check,
+	.quiesce		= ata_scsi_dump_quiesce,
+	.poll			= ata_scsi_dump_poll,
+	.no_write_cache_enable	= 1,
+};
diff -urNp linux-8143/drivers/scsi/libata-scsi.c linux-8144/drivers/scsi/libata-scsi.c
--- linux-8143/drivers/scsi/libata-scsi.c
+++ linux-8144/drivers/scsi/libata-scsi.c
@@ -90,8 +90,6 @@ static const u8 def_control_mpage[CONTRO
 	0, 30	/* extended self test time, see 05-359r1 */
 };
 
-static struct ata_device *
-ata_scsi_find_dev(struct ata_port *ap, const struct scsi_device *scsidev);
 
 static void ata_scsi_invalid_field(struct scsi_cmnd *cmd,
 				   void (*done)(struct scsi_cmnd *))
@@ -2120,7 +2118,7 @@ static unsigned int atapi_xlat(struct at
  *	Associated ATA device, or %NULL if not found.
  */
 
-static struct ata_device *
+struct ata_device *
 ata_scsi_find_dev(struct ata_port *ap, const struct scsi_device *scsidev)
 {
 	struct ata_device *dev;
diff -urNp linux-8143/drivers/scsi/libata.h linux-8144/drivers/scsi/libata.h
--- linux-8143/drivers/scsi/libata.h
+++ linux-8144/drivers/scsi/libata.h
@@ -52,6 +52,10 @@ extern void swap_buf_le16(u16 *buf, unsi
 extern int ata_task_ioctl(struct scsi_device *scsidev, void __user *arg);
 extern int ata_cmd_ioctl(struct scsi_device *scsidev, void __user *arg);
 
+extern struct ata_device *ata_scsi_find_dev(struct ata_port *ap,
+			const struct scsi_device *scsidev);
+extern void ata_pio_task(void *_data);
+
 /* libata-scsi.c */
 extern int ata_scsi_error(struct Scsi_Host *host);
 extern unsigned int ata_scsiop_inq_std(struct ata_scsi_args *args, u8 *rbuf,
diff -urNp linux-8143/drivers/scsi/sata_promise.c linux-8144/drivers/scsi/sata_promise.c
--- linux-8143/drivers/scsi/sata_promise.c
+++ linux-8144/drivers/scsi/sata_promise.c
@@ -40,6 +40,7 @@
 #include <linux/sched.h>
 #include "scsi.h"
 #include <scsi/scsi_host.h>
+#include "scsi_dump.h"
 #include <linux/libata.h>
 #include <asm/io.h>
 #include "sata_promise.h"
@@ -751,6 +752,7 @@ static int __init pdc_ata_init(void)
 		rc = -ENODEV;
 		goto err_out;
 	}
+	scsi_dump_register(&pdc_ata_sht, &ata_scsi_dump_ops);
 
 	return 0;
 
@@ -762,6 +764,7 @@ err_out:
 
 static void __exit pdc_ata_exit(void)
 {
+	scsi_dump_unregister(&pdc_ata_sht);
 	scsi_unregister_module(MODULE_SCSI_HA, &pdc_ata_sht);
 	pci_unregister_driver(&pdc_ata_pci_driver);
 }
diff -urNp linux-8143/include/linux/libata.h linux-8144/include/linux/libata.h
--- linux-8143/include/linux/libata.h
+++ linux-8144/include/linux/libata.h
@@ -444,6 +444,10 @@ extern int ata_scsi_queuecmd(struct scsi
 extern int ata_scsi_error(struct Scsi_Host *host);
 extern int ata_scsi_release(struct Scsi_Host *host);
 extern unsigned int ata_host_intr(struct ata_port *ap, struct ata_queued_cmd *qc);
+extern int ata_scsi_dump_sanity_check(struct scsi_device *sdev);
+extern int ata_scsi_dump_quiesce(struct scsi_device *sdev);
+extern void ata_scsi_dump_poll(struct scsi_device *sdev);
+extern struct scsi_dump_ops ata_scsi_dump_ops;
 extern int ata_ratelimit(void);
 
 /*
