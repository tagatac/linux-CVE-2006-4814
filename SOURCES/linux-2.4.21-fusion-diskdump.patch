diff -urNp linux-8151/drivers/message/fusion/linux_compat.h linux-8152/drivers/message/fusion/linux_compat.h
--- linux-8151/drivers/message/fusion/linux_compat.h
+++ linux-8152/drivers/message/fusion/linux_compat.h
@@ -8,6 +8,9 @@
 #include <linux/config.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+#include <linux/diskdumplib.h>
+#endif
 
 /*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 
@@ -281,6 +284,14 @@ static __inline__ int __get_order(unsign
                 spin_unlock_irqrestore(&io_request_lock, flags)
 #endif
 
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,1)
+	#define MPT_HOST_LOCK_INIT()
+#else
+	#define MPT_HOST_LOCK_INIT()	spin_lock_init(&io_request_lock)
+#endif
+#endif
+
 /*
  *  We use our new error handling code if the kernel version is 2.4.18 or newer.
  *  Remark: 5/5/03 use old EH code with 2.4 kernels as it runs in a background thread
@@ -316,6 +327,19 @@ static __inline__ int __get_order(unsign
 #define mpt_dec_use_count() MOD_DEC_USE_COUNT
 #endif
 
+/*
+ *  Wrap timer functions to make them function after crash.
+ */
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+#undef	add_timer
+#define	add_timer	diskdump_add_timer
+#undef	del_timer_sync
+#define	del_timer_sync	diskdump_del_timer
+#undef	del_timer
+#define	del_timer	diskdump_del_timer
+#undef	mod_timer
+#define	mod_timer	diskdump_mod_timer
+#endif
 
 /*}-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 #endif /* _LINUX_COMPAT_H */
diff -urNp linux-8151/drivers/message/fusion/mptbase.c linux-8152/drivers/message/fusion/mptbase.c
--- linux-8151/drivers/message/fusion/mptbase.c
+++ linux-8152/drivers/message/fusion/mptbase.c
@@ -5160,6 +5160,20 @@ mptbase_sas_process_event_data(MPT_ADAPT
 
 }
 
+
+#if defined(CONFIG_SCSI_DUMP) || defined(CONFIG_SCSI_DUMP_MODULE)
+void
+mpt_poll_interrupt(MPT_ADAPTER *ioc)
+{
+	u32 intstat;
+
+	intstat = CHIPREG_READ32(&ioc->chip->IntStatus);
+
+	if(intstat & MPI_HIS_REPLY_MESSAGE_INTERRUPT)
+		mpt_interrupt(0, (void *)ioc, NULL);
+}
+#endif
+
 /*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 
 /* mptbase_sas_update_device_list - This is called from the work queue.
@@ -5196,6 +5210,10 @@ mptbase_sas_update_device_list(void * ar
 
 }
 
+#if defined(CONFIG_SCSI_DUMP) || defined(CONFIG_SCSI_DUMP_MODULE)
+EXPORT_SYMBOL(mpt_poll_interrupt);
+#endif
+
 /*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 /*
  *	mptbase_sas_persist_operation - Perform operation on SAS Persitent Table
diff -urNp linux-8151/drivers/message/fusion/mptbase.h linux-8152/drivers/message/fusion/mptbase.h
--- linux-8151/drivers/message/fusion/mptbase.h
+++ linux-8152/drivers/message/fusion/mptbase.h
@@ -1048,6 +1048,10 @@ typedef struct _mpt_sge {
 
 /*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 
+#if defined(CONFIG_SCSI_DUMP) || defined(CONFIG_SCSI_DUMP_MODULE)
+extern void	 mpt_poll_interrupt(MPT_ADAPTER *ioc);
+#endif
+
 /*
  * MPT_SCSI_HOST defines - Used by the IOCTL and the SCSI drivers
  * Private to the driver.
diff -urNp linux-8151/drivers/message/fusion/mptscsih.c linux-8152/drivers/message/fusion/mptscsih.c
--- linux-8151/drivers/message/fusion/mptscsih.c
+++ linux-8152/drivers/message/fusion/mptscsih.c
@@ -59,6 +59,9 @@
 #include <linux/reboot.h>	/* notifier code */
 #include "../../scsi/scsi.h"
 #include "../../scsi/hosts.h"
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+#include "../../scsi/scsi_dump.h"
+#endif
 #if LINUX_VERSION_CODE < KERNEL_VERSION(2,5,45)
 #include "../../scsi/sd.h"
 #endif
@@ -213,6 +216,11 @@ static void	mptscsih_fillbuf(char *buffe
 #endif
 static int	mptscsih_halt(struct notifier_block *nb, ulong event, void *buf);
 static void	mptscsih_sas_persist_clear_table(void *arg);
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+static int	mptscsih_sanity_check(Scsi_Device *SDev);
+static int	mptscsih_quiesce(Scsi_Device *SDev);
+static void	mptscsih_poll(Scsi_Device *SDev);
+#endif
 
 /*
  *	Reboot Notification
@@ -3664,7 +3672,17 @@ SCPNT_TO_LOOKUP_IDX(Scsi_Cmnd *sc)
 /* see mptscsih.h */
 
 #ifdef MPT_SCSIHOST_NEED_ENTRY_EXIT_HOOKUPS
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+	static struct scsi_dump_ops mptscsih_dump_ops = {
+		.sanity_check	= mptscsih_sanity_check,
+		.quiesce	= mptscsih_quiesce,
+		.poll		= mptscsih_poll
+	};
+	static Scsi_Host_Template_dump driver_template_dump = MPT_SCSIHOST;
+#define driver_template	(driver_template_dump.hostt)
+#else
 	static Scsi_Host_Template driver_template = MPT_SCSIHOST;
+#endif
 #	include "../../scsi/scsi_module.c"
 #endif
 
@@ -7851,3 +7869,44 @@ mptscsih_fillbuf(char *buffer, int size,
 	}
 }
 #endif /* ~MPTSCSIH_ENABLE_DOMAIN_VALIDATION */
+
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+static int
+mptscsih_sanity_check(Scsi_Device *SDev)
+{
+	MPT_SCSI_HOST *hd;
+	MPT_ADAPTER *ioc;
+
+	hd = (MPT_SCSI_HOST *) SDev->host->hostdata;
+	if (hd == NULL)
+		return -ENXIO;
+	ioc = hd->ioc;
+
+	/* message frame freeQ is busy */
+	if (spin_is_locked(&ioc->FreeQlock))
+		return -EBUSY;
+
+	return 0;
+}
+
+static int
+mptscsih_quiesce(Scsi_Device *SDev)
+{
+	MPT_HOST_LOCK_INIT();
+	return 0;
+}
+
+static void
+mptscsih_poll(Scsi_Device *SDev)
+{
+	MPT_SCSI_HOST *hd;
+	u32 intstat;
+
+	hd = (MPT_SCSI_HOST *) SDev->host->hostdata;
+	if (!hd)
+		return;
+
+	/* check interrupt pending */
+	mpt_poll_interrupt(hd->ioc);
+}
+#endif
diff -urNp linux-8151/drivers/message/fusion/mptscsih.h linux-8152/drivers/message/fusion/mptscsih.h
--- linux-8151/drivers/message/fusion/mptscsih.h
+++ linux-8152/drivers/message/fusion/mptscsih.h
@@ -157,7 +157,7 @@ extern	int		 x_scsi_proc_info(char *, ch
 #endif
 
 #ifdef MPT_SCSI_USE_NEW_EH
-#define MPT_SCSIHOST {						\
+#define _MPT_SCSIHOST {						\
 	.next				= NULL,			\
 	PROC_SCSI_DECL						\
 	.proc_info			= x_scsi_proc_info,	\
@@ -180,12 +180,12 @@ extern	int		 x_scsi_proc_info(char *, ch
 	.unchecked_isa_dma		= 0,			\
 	.use_clustering			= ENABLE_CLUSTERING,	\
 	.vary_io			= 1,			\
-	.use_new_eh_code		= 1			\
-}
+	.use_new_eh_code		= 1
+
 
 #else /* MPT_SCSI_USE_NEW_EH */
 
-#define MPT_SCSIHOST {						\
+#define _MPT_SCSIHOST 						\
 	.next				= NULL,			\
 	PROC_SCSI_DECL						\
 	.name				= "MPT SCSI Host",	\
@@ -203,10 +203,22 @@ extern	int		 x_scsi_proc_info(char *, ch
 	.cmd_per_lun			= MPT_SCSI_CMD_PER_LUN,	\
 	.unchecked_isa_dma		= 0,			\
 	.use_clustering			= ENABLE_CLUSTERING,	\
-	.vary_io			= 1                     \
-}
+	.vary_io			= 1
+
 #endif  /* MPT_SCSI_USE_NEW_EH */
 
+#if defined(CONFIG_DISKDUMP) || defined(CONFIG_DISKDUMP_MODULE)
+#define MPT_SCSIHOST { 						\
+	.hostt = {						\
+		_MPT_SCSIHOST,					\
+		.disk_dump		= 1			\
+	},							\
+	.dump_ops			= &mptscsih_dump_ops	\
+}
+#else
+#define MPT_SCSIHOST { _MPT_SCSIHOST }
+#endif
+
 
 /*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/
 
