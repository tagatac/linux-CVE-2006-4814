diff -urNp linux-1190/arch/i386/kernel/setup.c linux-1200/arch/i386/kernel/setup.c
--- linux-1190/arch/i386/kernel/setup.c
+++ linux-1200/arch/i386/kernel/setup.c
@@ -1166,10 +1166,14 @@ static void __init noht_init(void)
 	}
 }
 
+unsigned long __TASK_SIZE = 0xc0000000;
+
 void __init setup_arch(char **cmdline_p)
 {
 	unsigned long max_low_pfn;
 
+	init_mm.task_size = PAGE_OFFSET_USER;
+
 #ifdef CONFIG_VISWS
 	visws_get_board_type_and_rev();
 #endif
diff -urNp linux-1190/arch/x86_64/ia32/ia32_binfmt.c linux-1200/arch/x86_64/ia32/ia32_binfmt.c
--- linux-1190/arch/x86_64/ia32/ia32_binfmt.c
+++ linux-1200/arch/x86_64/ia32/ia32_binfmt.c
@@ -12,6 +12,7 @@
 #include <linux/rwsem.h>
 #include <linux/sched.h>
 #include <linux/string.h>
+#include <linux/personality.h>
 #include <asm/segment.h> 
 #include <asm/ptrace.h>
 #include <asm/processor.h>
diff -urNp linux-1190/fs/exec.c linux-1200/fs/exec.c
--- linux-1190/fs/exec.c
+++ linux-1200/fs/exec.c
@@ -470,6 +470,8 @@ static int exec_mmap(void)
 			mmdrop(mm);
 			return -ENOMEM;
 		}
+		if (old_mm)
+			mm->task_size = current->mm->task_size;
 
 		/* Add it to the list of mm's */
 		spin_lock(&mmlist_lock);
@@ -749,6 +751,12 @@ int flush_old_exec(struct linux_binprm *
 	current->comm[i] = '\0';
 
 	current->flags &= ~PF_RELOCEXEC;
+#if defined(__i386__)
+	if (current->personality == PER_LINUX32)
+		current->mm->task_size = __TASK_SIZE;
+	else
+		current->mm->task_size = PAGE_OFFSET_USER;
+#endif
 	flush_thread();
 
 	if (bprm->e_uid != current->euid || bprm->e_gid != current->egid || 
diff -urNp linux-1190/include/asm-i386/elf.h linux-1200/include/asm-i386/elf.h
--- linux-1190/include/asm-i386/elf.h
+++ linux-1200/include/asm-i386/elf.h
@@ -101,7 +101,9 @@ typedef struct user_fxsr_struct elf_fpxr
 #define ELF_PLATFORM  (system_utsname.machine)
 
 #ifdef __KERNEL__
-#define SET_PERSONALITY(ex, ibcs2) set_personality((ibcs2)?PER_SVR4:PER_LINUX)
+
+/* child inherits the personality of the parent */
+#define SET_PERSONALITY(ex, ibcs2) do { } while (0)
 
 extern int dump_task_regs (struct task_struct *, elf_gregset_t *);
 extern int dump_task_fpu (struct task_struct *, elf_fpregset_t *);
diff -urNp linux-1190/include/asm-i386/processor.h linux-1200/include/asm-i386/processor.h
--- linux-1190/include/asm-i386/processor.h
+++ linux-1200/include/asm-i386/processor.h
@@ -281,7 +281,8 @@ extern unsigned int mca_pentium_flag;
 /*
  * User space process size: 3GB (default).
  */
-#define TASK_SIZE	(PAGE_OFFSET_USER)
+extern unsigned long __TASK_SIZE;
+#define TASK_SIZE (current->active_mm->task_size)
 
 /* This decides where the kernel will search for a free chunk of vm
  * space during mmap's.
diff -urNp linux-1190/include/linux/personality.h linux-1200/include/linux/personality.h
--- linux-1190/include/linux/personality.h
+++ linux-1200/include/linux/personality.h
@@ -34,6 +34,7 @@ enum {
 	SHORT_INODE =		0x1000000,
 	WHOLE_SECONDS =		0x2000000,
 	STICKY_TIMEOUTS	=	0x4000000,
+	ADDR_LIMIT_3GB = 	0x8000000,
 };
 
 /*
@@ -56,6 +57,7 @@ enum {
 	PER_SUNOS =		0x0006 | STICKY_TIMEOUTS,
 	PER_XENIX =		0x0007 | STICKY_TIMEOUTS | SHORT_INODE,
 	PER_LINUX32 =		0x0008,
+	PER_LINUX32_3GB =	0x0008 | ADDR_LIMIT_3GB,
 	PER_IRIX32 =		0x0009 | STICKY_TIMEOUTS,/* IRIX5 32-bit */
 	PER_IRIXN32 =		0x000a | STICKY_TIMEOUTS,/* IRIX6 new 32-bit */
 	PER_IRIX64 =		0x000b | STICKY_TIMEOUTS,/* IRIX6 64-bit */
diff -urNp linux-1190/include/linux/sched.h linux-1200/include/linux/sched.h
--- linux-1190/include/linux/sched.h
+++ linux-1200/include/linux/sched.h
@@ -288,6 +288,7 @@ struct mm_struct {
 						 * by mmlist_lock
 						 */
 
+	unsigned long task_size;
 	unsigned long start_code, end_code, start_data, end_data;
 	unsigned long start_brk, brk, start_stack;
 	unsigned long arg_start, arg_end, env_start, env_end;
diff -urNp linux-1190/include/linux/sysctl.h linux-1200/include/linux/sysctl.h
--- linux-1190/include/linux/sysctl.h
+++ linux-1200/include/linux/sysctl.h
@@ -128,6 +128,7 @@ enum
  	KERN_CORE_PATTERN=56,	/* string: pattern for core-files */
  	KERN_CORE_SETUID=58,	/* int: set to allow core dumps of setuid apps */
 	KERN_SERCONS_ESC=59,	/* int: ascii code of ser-cons "break" or -1 */
+	KERN_TASK_SIZE=60,	/* int: process VM size */
 	KERN_HONOR_UAC_NOPRINT=61, /* int: allow access to UAC_NOPRINT prctl */
 };
 
diff -urNp linux-1190/kernel/sysctl.c linux-1200/kernel/sysctl.c
--- linux-1190/kernel/sysctl.c
+++ linux-1200/kernel/sysctl.c
@@ -217,6 +217,10 @@ static ctl_table kern_table[] = {
 	 0644, NULL, &proc_dointvec},
 	{KERN_CAP_BSET, "cap-bound", &cap_bset, sizeof(kernel_cap_t),
 	 0600, NULL, &proc_dointvec_bset},
+#if defined(__i386__)
+	{KERN_TASK_SIZE, "task_size", &__TASK_SIZE, sizeof(int),
+	 0644, NULL, &proc_dointvec},
+#endif
 #ifdef CONFIG_BLK_DEV_INITRD
 	{KERN_REALROOTDEV, "real-root-dev", &real_root_dev, sizeof(int),
 	 0644, NULL, &proc_dointvec},
